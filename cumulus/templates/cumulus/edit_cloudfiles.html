{% extends "admin/base_site.html" %}
{% load adminmedia i18n %}

{% block extrastyle %}
    {{ block.super }}
    <link rel="stylesheet" type="text/css" href="{% admin_media_prefix %}css/changelists.css" />
    <style type="text/css" media="screen">
        #cloudfiles-edit .loading {
            padding-left: 16px;
            background: transparent url(http://cdn.cloudfiles.mosso.com/c164791/django-loader.gif) no-repeat;
        }
    </style>
{% endblock %}

{% block extrahead %}
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js" type="text/javascript" charset="utf-8"></script>
    <script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
            var accountID = "{{ account.id }}";
            var listURL = "{% url admin:cumulus-edit-cloudfiles account.id %}";
            var containerList = $('#changelist');
            var editDiv = $('#cloudfiles-edit');
            var createLink = $('#create-link');
            
            var handleContainerInfo = function(responseText, textStatus, XMLHttpRequest){
                editDiv.html(responseText);
                var form = $('#container-form');
                var radioBtns = $('#container-form :checkbox');
                radioBtns.change(function(e){
                    // show the loader graphic
                    editDiv.html('<p class="loading">Setting container access&hellip;</p>');
                    var data = form.serialize();
                    $.post(form.attr('action'), data, handleContainerInfo);
                });
            };
            
            var handleCreateForm = function(){
                var createForm = $('#create-form');
                createForm.submit(function(e){
                    e.preventDefault();
                    // show the loader graphic
                    editDiv.html('<p class="loading">Creating container&hellip;</p>');
                    // get the form data and post it
                    var data = createForm.serialize();
                    $.post(createForm.attr('action'), data, function(data, textStatus){
                        if(data == "success") {
                            // reload the container list
                            containerList.load(listURL, function(){
                                setListActions();
                                editDiv.empty();
                            });
                        } else {
                            // creation failed, show the form
                            editDiv.html(data);
                            handleCreateForm();
                        }
                    });
                });
            };
            
            var setListActions = function(){
                var aTags = $('.container-link', '#changelist');
                aTags.click(function(e){
                    e.preventDefault();
                    // show the loader graphic
                    editDiv.html('<p class="loading">Getting container info&hellip;</p>');
                    var aTag = $(this);
                    $.get(aTag.attr('href'), handleContainerInfo);
                });
            };
            setListActions();
            
            createLink.click(function(e){
                e.preventDefault();
                editDiv.load($(this).attr('href'), handleCreateForm);
            });
        });
    </script>
{% endblock %}

{% block bodyclass %}edit-cloudfiles{% endblock %}

{% block breadcrumbs %}
    <div class="breadcrumbs">
        <a href="../../../../">{% trans "Home" %}</a>
        &rsaquo; <a href="../../../">Cumulus</a>
        &rsaquo; <a href="../../">Accounts</a>
        {% if title %} &rsaquo; {{ title }}{% endif %}
    </div>
{% endblock %}

{% block content %}
    <div id="content-main">
        {% block object-tools %}
            <ul class="object-tools">
              <li>
                <a href="{% url admin:cumulus-create-container account.id %}" class="addlink" id="create-link">Create Container</a>
              </li>
            </ul>
        {% endblock %}
        
        <p>Account with username {{ account.username }} has {{ container_count }} container{{ container_count|pluralize }} ({{ bytes_used|filesizeformat }} total)</p>
        
        <div class="module" id="changelist">
            {% include "cumulus/includes/container_list.html" %}
        </div>
        
        <div id="cloudfiles-edit"></div>
    </div>
{% endblock %}